function audioBufferToWav(t,e){var i=t.numberOfChannels,s=t.sampleRate,e=(e=e||{}).float32?3:1,a=3==e?32:16;return encodeWAV(2===i?interleave(t.getChannelData(0),t.getChannelData(1)):t.getChannelData(0),e,s,i,a)}function encodeWAV(t,e,i,s,a){var n=a/8,r=s*n,o=new ArrayBuffer(44+t.length*n),l=new DataView(o);return writeString(l,0,"RIFF"),l.setUint32(4,36+t.length*n,!0),writeString(l,8,"WAVE"),writeString(l,12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,e,!0),l.setUint16(22,s,!0),l.setUint32(24,i,!0),l.setUint32(28,i*r,!0),l.setUint16(32,r,!0),l.setUint16(34,a,!0),writeString(l,36,"data"),l.setUint32(40,t.length*n,!0),(1===e?floatTo16BitPCM:writeFloat32)(l,44,t),o}function interleave(t,e){for(var i=t.length+e.length,s=new Float32Array(i),a=0,n=0;a<i;)s[a++]=t[n],s[a++]=e[n],n++;return s}function writeFloat32(t,e,i){for(var s=0;s<i.length;s++,e+=4)t.setFloat32(e,i[s],!0)}function floatTo16BitPCM(t,e,i){for(var s=0;s<i.length;s++,e+=2){var a=Math.max(-1,Math.min(1,i[s]));t.setInt16(e,a<0?32768*a:32767*a,!0)}}function writeString(t,e,i){for(var s=0;s<i.length;s++)t.setUint8(e+s,i.charCodeAt(s))}!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).WaveformData=e()}(this,function(){"use strict";function s(t,e){this._waveformData=t,this._channelIndex=e}s.prototype.min_sample=function(t){t=2*(t*this._waveformData.channels+this._channelIndex);return this._waveformData._at(t)},s.prototype.max_sample=function(t){t=2*(t*this._waveformData.channels+this._channelIndex)+1;return this._waveformData._at(t)},s.prototype.set_min_sample=function(t,e){t=2*(t*this._waveformData.channels+this._channelIndex);return this._waveformData._set_at(t,e)},s.prototype.set_max_sample=function(t,e){t=2*(t*this._waveformData.channels+this._channelIndex)+1;return this._waveformData._set_at(t,e)},s.prototype.min_array=function(){return this._waveformData._offsetValues(0,this._waveformData.length,2*this._channelIndex)},s.prototype.max_array=function(){return this._waveformData._offsetValues(0,this._waveformData.length,2*this._channelIndex+1)};var p=127,f=-128;function a(t){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var n=null;try{n=("undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads")).Worker}catch(s){}t="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgLyoqCiAgICogQXVkaW9CdWZmZXItYmFzZWQgV2F2ZWZvcm1EYXRhIGdlbmVyYXRvcgogICAqCiAgICogQWRhcHRlZCBmcm9tIEJsb2NrRmlsZTo6Q2FsY1N1bW1hcnkgaW4gQXVkYWNpdHksIHdpdGggcGVybWlzc2lvbi4KICAgKiBTZWUgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9hdWRhY2l0eS9zb3VyY2UvYnJvd3NlL2F1ZGFjaXR5LXNyYy90cnVuay9zcmMvQmxvY2tGaWxlLmNwcAogICAqLwogIHZhciBJTlQ4X01BWCA9IDEyNzsKICB2YXIgSU5UOF9NSU4gPSAtMTI4OwoKICBmdW5jdGlvbiBjYWxjdWxhdGVXYXZlZm9ybURhdGFMZW5ndGgoYXVkaW9fc2FtcGxlX2NvdW50LCBzY2FsZSkgewogICAgdmFyIGRhdGFfbGVuZ3RoID0gTWF0aC5mbG9vcihhdWRpb19zYW1wbGVfY291bnQgLyBzY2FsZSk7CiAgICB2YXIgc2FtcGxlc19yZW1haW5pbmcgPSBhdWRpb19zYW1wbGVfY291bnQgLSBkYXRhX2xlbmd0aCAqIHNjYWxlOwoKICAgIGlmIChzYW1wbGVzX3JlbWFpbmluZyA+IDApIHsKICAgICAgZGF0YV9sZW5ndGgrKzsKICAgIH0KCiAgICByZXR1cm4gZGF0YV9sZW5ndGg7CiAgfQoKICBmdW5jdGlvbiBnZW5lcmF0ZVdhdmVmb3JtRGF0YShvcHRpb25zKSB7CiAgICB2YXIgc2NhbGUgPSBvcHRpb25zLnNjYWxlOwogICAgdmFyIGFtcGxpdHVkZV9zY2FsZSA9IG9wdGlvbnMuYW1wbGl0dWRlX3NjYWxlOwogICAgdmFyIHNwbGl0X2NoYW5uZWxzID0gb3B0aW9ucy5zcGxpdF9jaGFubmVsczsKICAgIHZhciBsZW5ndGggPSBvcHRpb25zLmxlbmd0aDsKICAgIHZhciBzYW1wbGVfcmF0ZSA9IG9wdGlvbnMuc2FtcGxlX3JhdGU7CiAgICB2YXIgY2hhbm5lbHMgPSBvcHRpb25zLmNoYW5uZWxzLm1hcChmdW5jdGlvbiAoY2hhbm5lbCkgewogICAgICByZXR1cm4gbmV3IEZsb2F0MzJBcnJheShjaGFubmVsKTsKICAgIH0pOwogICAgdmFyIG91dHB1dF9jaGFubmVscyA9IHNwbGl0X2NoYW5uZWxzID8gY2hhbm5lbHMubGVuZ3RoIDogMTsKICAgIHZhciB2ZXJzaW9uID0gb3V0cHV0X2NoYW5uZWxzID09PSAxID8gMSA6IDI7CiAgICB2YXIgaGVhZGVyX3NpemUgPSB2ZXJzaW9uID09PSAxID8gMjAgOiAyNDsKICAgIHZhciBkYXRhX2xlbmd0aCA9IGNhbGN1bGF0ZVdhdmVmb3JtRGF0YUxlbmd0aChsZW5ndGgsIHNjYWxlKTsKICAgIHZhciB0b3RhbF9zaXplID0gaGVhZGVyX3NpemUgKyBkYXRhX2xlbmd0aCAqIDIgKiBvdXRwdXRfY2hhbm5lbHM7CiAgICB2YXIgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKHRvdGFsX3NpemUpOwogICAgdmFyIGRhdGFfdmlldyA9IG5ldyBEYXRhVmlldyhidWZmZXIpOwogICAgdmFyIHNjYWxlX2NvdW50ZXIgPSAwOwogICAgdmFyIG9mZnNldCA9IGhlYWRlcl9zaXplOwogICAgdmFyIGNoYW5uZWwsIGk7CiAgICB2YXIgbWluX3ZhbHVlID0gbmV3IEFycmF5KG91dHB1dF9jaGFubmVscyk7CiAgICB2YXIgbWF4X3ZhbHVlID0gbmV3IEFycmF5KG91dHB1dF9jaGFubmVscyk7CgogICAgZm9yIChjaGFubmVsID0gMDsgY2hhbm5lbCA8IG91dHB1dF9jaGFubmVsczsgY2hhbm5lbCsrKSB7CiAgICAgIG1pbl92YWx1ZVtjaGFubmVsXSA9IEluZmluaXR5OwogICAgICBtYXhfdmFsdWVbY2hhbm5lbF0gPSAtSW5maW5pdHk7CiAgICB9CgogICAgZGF0YV92aWV3LnNldEludDMyKDAsIHZlcnNpb24sIHRydWUpOyAvLyBWZXJzaW9uCgogICAgZGF0YV92aWV3LnNldFVpbnQzMig0LCAxLCB0cnVlKTsgLy8gSXMgOCBiaXQ/CgogICAgZGF0YV92aWV3LnNldEludDMyKDgsIHNhbXBsZV9yYXRlLCB0cnVlKTsgLy8gU2FtcGxlIHJhdGUKCiAgICBkYXRhX3ZpZXcuc2V0SW50MzIoMTIsIHNjYWxlLCB0cnVlKTsgLy8gU2NhbGUKCiAgICBkYXRhX3ZpZXcuc2V0SW50MzIoMTYsIGRhdGFfbGVuZ3RoLCB0cnVlKTsgLy8gTGVuZ3RoCgogICAgaWYgKHZlcnNpb24gPT09IDIpIHsKICAgICAgZGF0YV92aWV3LnNldEludDMyKDIwLCBvdXRwdXRfY2hhbm5lbHMsIHRydWUpOwogICAgfQoKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICB2YXIgc2FtcGxlID0gMDsKCiAgICAgIGlmIChvdXRwdXRfY2hhbm5lbHMgPT09IDEpIHsKICAgICAgICBmb3IgKGNoYW5uZWwgPSAwOyBjaGFubmVsIDwgY2hhbm5lbHMubGVuZ3RoOyArK2NoYW5uZWwpIHsKICAgICAgICAgIHNhbXBsZSArPSBjaGFubmVsc1tjaGFubmVsXVtpXTsKICAgICAgICB9CgogICAgICAgIHNhbXBsZSA9IE1hdGguZmxvb3IoSU5UOF9NQVggKiBzYW1wbGUgKiBhbXBsaXR1ZGVfc2NhbGUgLyBjaGFubmVscy5sZW5ndGgpOwoKICAgICAgICBpZiAoc2FtcGxlIDwgbWluX3ZhbHVlWzBdKSB7CiAgICAgICAgICBtaW5fdmFsdWVbMF0gPSBzYW1wbGU7CgogICAgICAgICAgaWYgKG1pbl92YWx1ZVswXSA8IElOVDhfTUlOKSB7CiAgICAgICAgICAgIG1pbl92YWx1ZVswXSA9IElOVDhfTUlOOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHNhbXBsZSA+IG1heF92YWx1ZVswXSkgewogICAgICAgICAgbWF4X3ZhbHVlWzBdID0gc2FtcGxlOwoKICAgICAgICAgIGlmIChtYXhfdmFsdWVbMF0gPiBJTlQ4X01BWCkgewogICAgICAgICAgICBtYXhfdmFsdWVbMF0gPSBJTlQ4X01BWDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChjaGFubmVsID0gMDsgY2hhbm5lbCA8IG91dHB1dF9jaGFubmVsczsgKytjaGFubmVsKSB7CiAgICAgICAgICBzYW1wbGUgPSBNYXRoLmZsb29yKElOVDhfTUFYICogY2hhbm5lbHNbY2hhbm5lbF1baV0gKiBhbXBsaXR1ZGVfc2NhbGUpOwoKICAgICAgICAgIGlmIChzYW1wbGUgPCBtaW5fdmFsdWVbY2hhbm5lbF0pIHsKICAgICAgICAgICAgbWluX3ZhbHVlW2NoYW5uZWxdID0gc2FtcGxlOwoKICAgICAgICAgICAgaWYgKG1pbl92YWx1ZVtjaGFubmVsXSA8IElOVDhfTUlOKSB7CiAgICAgICAgICAgICAgbWluX3ZhbHVlW2NoYW5uZWxdID0gSU5UOF9NSU47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoc2FtcGxlID4gbWF4X3ZhbHVlW2NoYW5uZWxdKSB7CiAgICAgICAgICAgIG1heF92YWx1ZVtjaGFubmVsXSA9IHNhbXBsZTsKCiAgICAgICAgICAgIGlmIChtYXhfdmFsdWVbY2hhbm5lbF0gPiBJTlQ4X01BWCkgewogICAgICAgICAgICAgIG1heF92YWx1ZVtjaGFubmVsXSA9IElOVDhfTUFYOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoKytzY2FsZV9jb3VudGVyID09PSBzY2FsZSkgewogICAgICAgIGZvciAoY2hhbm5lbCA9IDA7IGNoYW5uZWwgPCBvdXRwdXRfY2hhbm5lbHM7IGNoYW5uZWwrKykgewogICAgICAgICAgZGF0YV92aWV3LnNldEludDgob2Zmc2V0KyssIG1pbl92YWx1ZVtjaGFubmVsXSk7CiAgICAgICAgICBkYXRhX3ZpZXcuc2V0SW50OChvZmZzZXQrKywgbWF4X3ZhbHVlW2NoYW5uZWxdKTsKICAgICAgICAgIG1pbl92YWx1ZVtjaGFubmVsXSA9IEluZmluaXR5OwogICAgICAgICAgbWF4X3ZhbHVlW2NoYW5uZWxdID0gLUluZmluaXR5OwogICAgICAgIH0KCiAgICAgICAgc2NhbGVfY291bnRlciA9IDA7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoc2NhbGVfY291bnRlciA+IDApIHsKICAgICAgZm9yIChjaGFubmVsID0gMDsgY2hhbm5lbCA8IG91dHB1dF9jaGFubmVsczsgY2hhbm5lbCsrKSB7CiAgICAgICAgZGF0YV92aWV3LnNldEludDgob2Zmc2V0KyssIG1pbl92YWx1ZVtjaGFubmVsXSk7CiAgICAgICAgZGF0YV92aWV3LnNldEludDgob2Zmc2V0KyssIG1heF92YWx1ZVtjaGFubmVsXSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYnVmZmVyOwogIH0KCiAgb25tZXNzYWdlID0gZnVuY3Rpb24gb25tZXNzYWdlKGV2dCkgewogICAgdmFyIGJ1ZmZlciA9IGdlbmVyYXRlV2F2ZWZvcm1EYXRhKGV2dC5kYXRhKTsgLy8gVHJhbnNmZXIgYnVmZmVyIHRvIHRoZSBjYWxsaW5nIHRocmVhZAoKICAgIHRoaXMucG9zdE1lc3NhZ2UoYnVmZmVyLCBbYnVmZmVyXSk7CiAgICB0aGlzLmNsb3NlKCk7CiAgfTsKCn0pKCk7Cgo=";var t,r,o="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0)?function(t,e,i){e=void 0===e?null:e;i=void 0!==i&&i;var i=(t=Buffer.from(t,"base64").toString(i?"utf16":"utf8")).indexOf("\n",10)+1,s=t.substring(i)+(e?"//# sourceMappingURL="+e:"");return function(t){return new n(s,Object.assign({},t,{eval:!0}))}}(t,null,!1):function(t){return r=r||(e=void 0===(e=null)?null:e,s=(i=function(t){var e=atob(n);if(t){for(var i=new Uint8Array(e.length),s=0,a=e.length;s<a;++s)i[s]=e.charCodeAt(s);return String.fromCharCode.apply(null,new Uint16Array(i.buffer))}return e}(void 0!==(i=!(n="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgLyoqCiAgICogQXVkaW9CdWZmZXItYmFzZWQgV2F2ZWZvcm1EYXRhIGdlbmVyYXRvcgogICAqCiAgICogQWRhcHRlZCBmcm9tIEJsb2NrRmlsZTo6Q2FsY1N1bW1hcnkgaW4gQXVkYWNpdHksIHdpdGggcGVybWlzc2lvbi4KICAgKiBTZWUgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9hdWRhY2l0eS9zb3VyY2UvYnJvd3NlL2F1ZGFjaXR5LXNyYy90cnVuay9zcmMvQmxvY2tGaWxlLmNwcAogICAqLwogIHZhciBJTlQ4X01BWCA9IDEyNzsKICB2YXIgSU5UOF9NSU4gPSAtMTI4OwoKICBmdW5jdGlvbiBjYWxjdWxhdGVXYXZlZm9ybURhdGFMZW5ndGgoYXVkaW9fc2FtcGxlX2NvdW50LCBzY2FsZSkgewogICAgdmFyIGRhdGFfbGVuZ3RoID0gTWF0aC5mbG9vcihhdWRpb19zYW1wbGVfY291bnQgLyBzY2FsZSk7CiAgICB2YXIgc2FtcGxlc19yZW1haW5pbmcgPSBhdWRpb19zYW1wbGVfY291bnQgLSBkYXRhX2xlbmd0aCAqIHNjYWxlOwoKICAgIGlmIChzYW1wbGVzX3JlbWFpbmluZyA+IDApIHsKICAgICAgZGF0YV9sZW5ndGgrKzsKICAgIH0KCiAgICByZXR1cm4gZGF0YV9sZW5ndGg7CiAgfQoKICBmdW5jdGlvbiBnZW5lcmF0ZVdhdmVmb3JtRGF0YShvcHRpb25zKSB7CiAgICB2YXIgc2NhbGUgPSBvcHRpb25zLnNjYWxlOwogICAgdmFyIGFtcGxpdHVkZV9zY2FsZSA9IG9wdGlvbnMuYW1wbGl0dWRlX3NjYWxlOwogICAgdmFyIHNwbGl0X2NoYW5uZWxzID0gb3B0aW9ucy5zcGxpdF9jaGFubmVsczsKICAgIHZhciBsZW5ndGggPSBvcHRpb25zLmxlbmd0aDsKICAgIHZhciBzYW1wbGVfcmF0ZSA9IG9wdGlvbnMuc2FtcGxlX3JhdGU7CiAgICB2YXIgY2hhbm5lbHMgPSBvcHRpb25zLmNoYW5uZWxzLm1hcChmdW5jdGlvbiAoY2hhbm5lbCkgewogICAgICByZXR1cm4gbmV3IEZsb2F0MzJBcnJheShjaGFubmVsKTsKICAgIH0pOwogICAgdmFyIG91dHB1dF9jaGFubmVscyA9IHNwbGl0X2NoYW5uZWxzID8gY2hhbm5lbHMubGVuZ3RoIDogMTsKICAgIHZhciB2ZXJzaW9uID0gb3V0cHV0X2NoYW5uZWxzID09PSAxID8gMSA6IDI7CiAgICB2YXIgaGVhZGVyX3NpemUgPSB2ZXJzaW9uID09PSAxID8gMjAgOiAyNDsKICAgIHZhciBkYXRhX2xlbmd0aCA9IGNhbGN1bGF0ZVdhdmVmb3JtRGF0YUxlbmd0aChsZW5ndGgsIHNjYWxlKTsKICAgIHZhciB0b3RhbF9zaXplID0gaGVhZGVyX3NpemUgKyBkYXRhX2xlbmd0aCAqIDIgKiBvdXRwdXRfY2hhbm5lbHM7CiAgICB2YXIgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKHRvdGFsX3NpemUpOwogICAgdmFyIGRhdGFfdmlldyA9IG5ldyBEYXRhVmlldyhidWZmZXIpOwogICAgdmFyIHNjYWxlX2NvdW50ZXIgPSAwOwogICAgdmFyIG9mZnNldCA9IGhlYWRlcl9zaXplOwogICAgdmFyIGNoYW5uZWwsIGk7CiAgICB2YXIgbWluX3ZhbHVlID0gbmV3IEFycmF5KG91dHB1dF9jaGFubmVscyk7CiAgICB2YXIgbWF4X3ZhbHVlID0gbmV3IEFycmF5KG91dHB1dF9jaGFubmVscyk7CgogICAgZm9yIChjaGFubmVsID0gMDsgY2hhbm5lbCA8IG91dHB1dF9jaGFubmVsczsgY2hhbm5lbCsrKSB7CiAgICAgIG1pbl92YWx1ZVtjaGFubmVsXSA9IEluZmluaXR5OwogICAgICBtYXhfdmFsdWVbY2hhbm5lbF0gPSAtSW5maW5pdHk7CiAgICB9CgogICAgZGF0YV92aWV3LnNldEludDMyKDAsIHZlcnNpb24sIHRydWUpOyAvLyBWZXJzaW9uCgogICAgZGF0YV92aWV3LnNldFVpbnQzMig0LCAxLCB0cnVlKTsgLy8gSXMgOCBiaXQ/CgogICAgZGF0YV92aWV3LnNldEludDMyKDgsIHNhbXBsZV9yYXRlLCB0cnVlKTsgLy8gU2FtcGxlIHJhdGUKCiAgICBkYXRhX3ZpZXcuc2V0SW50MzIoMTIsIHNjYWxlLCB0cnVlKTsgLy8gU2NhbGUKCiAgICBkYXRhX3ZpZXcuc2V0SW50MzIoMTYsIGRhdGFfbGVuZ3RoLCB0cnVlKTsgLy8gTGVuZ3RoCgogICAgaWYgKHZlcnNpb24gPT09IDIpIHsKICAgICAgZGF0YV92aWV3LnNldEludDMyKDIwLCBvdXRwdXRfY2hhbm5lbHMsIHRydWUpOwogICAgfQoKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICB2YXIgc2FtcGxlID0gMDsKCiAgICAgIGlmIChvdXRwdXRfY2hhbm5lbHMgPT09IDEpIHsKICAgICAgICBmb3IgKGNoYW5uZWwgPSAwOyBjaGFubmVsIDwgY2hhbm5lbHMubGVuZ3RoOyArK2NoYW5uZWwpIHsKICAgICAgICAgIHNhbXBsZSArPSBjaGFubmVsc1tjaGFubmVsXVtpXTsKICAgICAgICB9CgogICAgICAgIHNhbXBsZSA9IE1hdGguZmxvb3IoSU5UOF9NQVggKiBzYW1wbGUgKiBhbXBsaXR1ZGVfc2NhbGUgLyBjaGFubmVscy5sZW5ndGgpOwoKICAgICAgICBpZiAoc2FtcGxlIDwgbWluX3ZhbHVlWzBdKSB7CiAgICAgICAgICBtaW5fdmFsdWVbMF0gPSBzYW1wbGU7CgogICAgICAgICAgaWYgKG1pbl92YWx1ZVswXSA8IElOVDhfTUlOKSB7CiAgICAgICAgICAgIG1pbl92YWx1ZVswXSA9IElOVDhfTUlOOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHNhbXBsZSA+IG1heF92YWx1ZVswXSkgewogICAgICAgICAgbWF4X3ZhbHVlWzBdID0gc2FtcGxlOwoKICAgICAgICAgIGlmIChtYXhfdmFsdWVbMF0gPiBJTlQ4X01BWCkgewogICAgICAgICAgICBtYXhfdmFsdWVbMF0gPSBJTlQ4X01BWDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChjaGFubmVsID0gMDsgY2hhbm5lbCA8IG91dHB1dF9jaGFubmVsczsgKytjaGFubmVsKSB7CiAgICAgICAgICBzYW1wbGUgPSBNYXRoLmZsb29yKElOVDhfTUFYICogY2hhbm5lbHNbY2hhbm5lbF1baV0gKiBhbXBsaXR1ZGVfc2NhbGUpOwoKICAgICAgICAgIGlmIChzYW1wbGUgPCBtaW5fdmFsdWVbY2hhbm5lbF0pIHsKICAgICAgICAgICAgbWluX3ZhbHVlW2NoYW5uZWxdID0gc2FtcGxlOwoKICAgICAgICAgICAgaWYgKG1pbl92YWx1ZVtjaGFubmVsXSA8IElOVDhfTUlOKSB7CiAgICAgICAgICAgICAgbWluX3ZhbHVlW2NoYW5uZWxdID0gSU5UOF9NSU47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoc2FtcGxlID4gbWF4X3ZhbHVlW2NoYW5uZWxdKSB7CiAgICAgICAgICAgIG1heF92YWx1ZVtjaGFubmVsXSA9IHNhbXBsZTsKCiAgICAgICAgICAgIGlmIChtYXhfdmFsdWVbY2hhbm5lbF0gPiBJTlQ4X01BWCkgewogICAgICAgICAgICAgIG1heF92YWx1ZVtjaGFubmVsXSA9IElOVDhfTUFYOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoKytzY2FsZV9jb3VudGVyID09PSBzY2FsZSkgewogICAgICAgIGZvciAoY2hhbm5lbCA9IDA7IGNoYW5uZWwgPCBvdXRwdXRfY2hhbm5lbHM7IGNoYW5uZWwrKykgewogICAgICAgICAgZGF0YV92aWV3LnNldEludDgob2Zmc2V0KyssIG1pbl92YWx1ZVtjaGFubmVsXSk7CiAgICAgICAgICBkYXRhX3ZpZXcuc2V0SW50OChvZmZzZXQrKywgbWF4X3ZhbHVlW2NoYW5uZWxdKTsKICAgICAgICAgIG1pbl92YWx1ZVtjaGFubmVsXSA9IEluZmluaXR5OwogICAgICAgICAgbWF4X3ZhbHVlW2NoYW5uZWxdID0gLUluZmluaXR5OwogICAgICAgIH0KCiAgICAgICAgc2NhbGVfY291bnRlciA9IDA7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoc2NhbGVfY291bnRlciA+IDApIHsKICAgICAgZm9yIChjaGFubmVsID0gMDsgY2hhbm5lbCA8IG91dHB1dF9jaGFubmVsczsgY2hhbm5lbCsrKSB7CiAgICAgICAgZGF0YV92aWV3LnNldEludDgob2Zmc2V0KyssIG1pbl92YWx1ZVtjaGFubmVsXSk7CiAgICAgICAgZGF0YV92aWV3LnNldEludDgob2Zmc2V0KyssIG1heF92YWx1ZVtjaGFubmVsXSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYnVmZmVyOwogIH0KCiAgb25tZXNzYWdlID0gZnVuY3Rpb24gb25tZXNzYWdlKGV2dCkgewogICAgdmFyIGJ1ZmZlciA9IGdlbmVyYXRlV2F2ZWZvcm1EYXRhKGV2dC5kYXRhKTsgLy8gVHJhbnNmZXIgYnVmZmVyIHRvIHRoZSBjYWxsaW5nIHRocmVhZAoKICAgIHRoaXMucG9zdE1lc3NhZ2UoYnVmZmVyLCBbYnVmZmVyXSk7CiAgICB0aGlzLmNsb3NlKCk7CiAgfTsKCn0pKCk7Cgo="))&&i)).indexOf("\n",10)+1,i=i.substring(s)+(e?"//# sourceMappingURL="+e:""),s=new Blob([i],{type:"application/javascript"}),URL.createObjectURL(s)),new Worker(r,t);var n,e,i,s};function w(t){if(!function(t){var e=t&&"object"===a(t)&&"byteLength"in t;if(e){t=new DataView(t).getInt32(0,!0);if(1!==t&&2!==t)throw new TypeError("WaveformData.create(): This waveform data version not supported")}return e}(t=(e=t)&&"object"===a(e)&&"sample_rate"in e&&"samples_per_pixel"in e&&"bits"in e&&"length"in e&&"data"in e?function(t){var e=t.data,i=t.channels||1,s=8===t.bits?1:2,a=2*t.length*i;if(e.length!==a)throw new Error("WaveformData.create(): Length mismatch in JSON waveform data");var a=24+e.length*s,s=new ArrayBuffer(a),n=new DataView(s);n.setInt32(0,2,!0),n.setUint32(4,8===t.bits,!0),n.setInt32(8,t.sample_rate,!0),n.setInt32(12,t.samples_per_pixel,!0),n.setInt32(16,t.length,!0),n.setInt32(20,i,!0);var r,o=24;if(8===t.bits)for(r=0;r<e.length;r++)n.setInt8(o++,e[r],!0);else for(r=0;r<e.length;r++)n.setInt16(o,e[r],!0),o+=2;return s}(t):t))throw new TypeError("WaveformData.create(): Unknown data format");var e;this._data=new DataView(t),this._offset=2===this._version()?24:20,this._channels=[];for(var i=0;i<this.channels;i++)this._channels[i]=new s(this,i)}function l(e,t,i){var s,a=function(t){for(var e=[],i=0;i<t.numberOfChannels;++i)e.push(t.getChannelData(i).buffer);return e}(e);t.disable_worker?(s=function(t){for(var e,i,s=t.scale,a=t.amplitude_scale,n=t.split_channels,r=t.length,o=t.sample_rate,l=t.channels.map(function(t){return new Float32Array(t)}),h=n?l.length:1,n=1==(t=1===h?1:2)?20:24,g=(g=r,u=s,i=Math.floor(g/u),0<g-i*u&&i++,i),u=new ArrayBuffer(n+2*g*h),I=new DataView(u),c=0,d=n,C=new Array(h),m=new Array(h),A=0;A<h;A++)C[A]=1/0,m[A]=-1/0;for(I.setInt32(0,t,!0),I.setUint32(4,1,!0),I.setInt32(8,o,!0),I.setInt32(12,s,!0),I.setInt32(16,g,!0),2==t&&I.setInt32(20,h,!0),e=0;e<r;e++){var b=0;if(1===h){for(A=0;A<l.length;++A)b+=l[A][e];(b=Math.floor(p*b*a/l.length))<C[0]&&(C[0]=b,C[0]<f)&&(C[0]=f),b>m[0]&&(m[0]=b,m[0]>p)&&(m[0]=p)}else for(A=0;A<h;++A)(b=Math.floor(p*l[A][e]*a))<C[A]&&(C[A]=b,C[A]<f)&&(C[A]=f),b>m[A]&&(m[A]=b,m[A]>p)&&(m[A]=p);if(++c===s){for(A=0;A<h;A++)I.setInt8(d++,C[A]),I.setInt8(d++,m[A]),C[A]=1/0,m[A]=-1/0;c=0}}if(0<c)for(A=0;A<h;A++)I.setInt8(d++,C[A]),I.setInt8(d++,m[A]);return u}({scale:t.scale,amplitude_scale:t.amplitude_scale,split_channels:t.split_channels,length:e.length,sample_rate:e.sampleRate,channels:a}),i(null,new w(s),e)):((s=new o).onmessage=function(t){i(null,new w(t.data),e)},s.postMessage({scale:t.scale,amplitude_scale:t.amplitude_scale,split_channels:t.split_channels,length:e.length,sample_rate:e.sampleRate,channels:a},a))}return w.create=function(t){return new w(t)},w.createFromAudio=function(t,e){var i,s,a,n={scale:t.scale||512,amplitude_scale:t.amplitude_scale||1,split_channels:t.split_channels||!1,disable_worker:t.disable_worker||!1};if(!t.audio_context||!t.array_buffer){if(t.audio_buffer)return l(t.audio_buffer,n,e);throw new TypeError("WaveformData.createFromAudio(): Pass either an AudioContext and ArrayBuffer, or an AudioBuffer object")}i=t.audio_context,t=t.array_buffer,s=n,a=e,i.decodeAudioData(t,function(t){l(t,s,a)},function(t){t=t||new DOMException("EncodingError"),a(t)})},w.prototype={resample:function(t){if(t.scale="number"==typeof t.scale?t.scale:null,t.width="number"==typeof t.width?t.width:null,null!=t.width&&t.width<=0)throw new RangeError("WaveformData.resample(): width should be a positive integer value");if(null!=t.scale&&t.scale<=0)throw new RangeError("WaveformData.resample(): scale should be a positive integer value");if(!t.scale&&!t.width)throw new Error("WaveformData.resample(): Missing scale or width option");var e=t.scale||Math.floor(this.duration*this.sample_rate/t.width),i=this.scale,s=this.length,t=s*this.scale,t=Math.ceil(t/e),a=8===this.bits?1:2,a=24+2*t*this.channels*a,a=new ArrayBuffer(a),n=new DataView(a);n.setInt32(0,2,!0),n.setUint32(4,8===this.bits,!0),n.setInt32(8,this.sample_rate,!0),n.setInt32(12,e,!0),n.setInt32(16,t,!0),n.setInt32(20,this.channels,!0);for(var r=new w(a),o=0,l=0,h=this.channels,g=new Array(h),u=new Array(h),I=0;I<h;++I)0<s?(g[I]=this.channel(I).min_sample(o),u[I]=this.channel(I).max_sample(o)):(g[I]=0,u[I]=0);var c,d,C,m,A=8===this.bits?-128:-32768,b=8===this.bits?127:32767;if(e<i)throw new Error("WaveformData.resample(): Zoom level "+e+" too low, minimum: "+i);function p(t){return Math.floor(t*e)}for(;o<s;){for(;Math.floor(p(l)/i)===o;){if(0<l)for(I=0;I<h;++I)r.channel(I).set_min_sample(l-1,g[I]),r.channel(I).set_max_sample(l-1,u[I]);if(m=o,(c=p(++l))!==p(l-1))for(I=0;I<h;++I)g[I]=b,u[I]=A}for(c=p(l),(d=Math.floor(c/i))>s&&(d=s);o<d;){for(I=0;I<h;++I)(C=this.channel(I).min_sample(o))<g[I]&&(g[I]=C),(C=this.channel(I).max_sample(o))>u[I]&&(u[I]=C);o++}}if(o!==m)for(I=0;I<h;++I)r.channel(I).set_min_sample(l-1,g[I]),r.channel(I).set_max_sample(l-1,u[I]);return r},concat:function(){var e=this,t=Array.prototype.slice.call(arguments),t=(t.forEach(function(t){if(e.channels!==t.channels||e.sample_rate!==t.sample_rate||e.bits!==t.bits||e.scale!==t.scale)throw new Error("WaveformData.concat(): Waveforms are incompatible")}),this._concatBuffers.apply(this,t));return w.create(t)},_concatBuffers:function(){for(var t=Array.prototype.slice.call(arguments),e=this._offset,i=e,s=0,a=[this].concat(t).map(function(t){return t._data.buffer}),n=0;n<a.length;n++){var r=a[n],o=new DataView(r).getInt32(16,!0);i+=r.byteLength-e,s+=o}var t=new ArrayBuffer(i),l=new DataView(a[0]),h=new DataView(t);for(n=0;n<e;n++)h.setUint8(n,l.getUint8(n));h.setInt32(16,s,!0);var g=0,u=new Uint8Array(t,e);for(n=0;n<a.length;n++)r=a[n],u.set(new Uint8Array(r,e),g),g+=r.byteLength-e;return t},_offsetValues:function(t,e,i){var s=[],a=this.channels;i+=t*a*2;for(var n=0;n<e;n++)s.push(this._at(n*a*2+i));return s},_version:function(){return this._data.getInt32(0,!0)},get length(){return this._data.getUint32(16,!0)},get bits(){return Boolean(this._data.getUint32(4,!0))?8:16},get duration(){return this.length*this.scale/this.sample_rate},get pixels_per_second(){return this.sample_rate/this.scale},get seconds_per_pixel(){return this.scale/this.sample_rate},get channels(){return 2===this._version()?this._data.getInt32(20,!0):1},channel:function(t){if(0<=t&&t<this._channels.length)return this._channels[t];throw new RangeError("Invalid channel: "+t)},get sample_rate(){return this._data.getInt32(8,!0)},get scale(){return this._data.getInt32(12,!0)},_at:function(t){return 8===this.bits?this._data.getInt8(this._offset+t):this._data.getInt16(this._offset+2*t,!0)},_set_at:function(t,e){return 8===this.bits?this._data.setInt8(this._offset+t,e):this._data.setInt16(this._offset+2*t,e,!0)},at_time:function(t){return Math.floor(t*this.sample_rate/this.scale)},time:function(t){return t*this.scale/this.sample_rate},toJSON:function(){for(var t={version:2,channels:this.channels,sample_rate:this.sample_rate,samples_per_pixel:this.scale,bits:this.bits,length:this.length,data:[]},e=0;e<this.length;e++)for(var i=0;i<this.channels;i++)t.data.push(this.channel(i).min_sample(e)),t.data.push(this.channel(i).max_sample(e));return t},toArrayBuffer:function(){return this._data.buffer}},w});const ADJUST_WIDTH=10,ADJUST_HEIGHT=50,BUTTON_RADIUS=60,VIEW_BACK_COLOR="#AFAFAF",VIEW_MEASURE_LINE_COLOR="#CFCFCF",VIEW_BEAT_LINE_COLOR="#9F9F9F",VIEW_PROGRESS_COLOR="#FFFFFF",DEFAULT_VOL=.5,DEFAULT_BPM=120,DEFAULT_MEASURE_WIDTH=120,DEFAULT_DIVIDE_NUM=4,COLOR_DEFINE=[{wave:"#FF0000",back:"#7F0000",select:"#CF0000"},{wave:"#00FF00",back:"#007F00",select:"#00CF00"},{wave:"#0000FF",back:"#00007F",select:"#0000CF"},{wave:"#FFFF00",back:"#7F7F00",select:"#CFCF00"},{wave:"#00FFFF",back:"#007F7F",select:"#00CFCF"},{wave:"#FF00FF",back:"#7F007F",select:"#CF00CF"}];function GetRandomInt(t){return Math.floor(Math.random()*t)}function GetSecParMeasure(t){return 60/t*4}function GetSecParPixel(t,e){return GetSecParMeasure(t)/e}function GetSecFromWorldPos(t,e,i){return i*GetSecParPixel(t,e)}function GetMeasurePos(t,e){return e/t}function GetWorldPosFromMeasurePos(t,e,i){return i*e}function GetElem(t){return document.getElementById(t)}function GetParent(t){return document.getElementById(t).parentNode}function CreateSVGElem(t,e){t=document.createElementNS("http://www.w3.org/2000/svg",t);return null!=e&&(t.id=e),t}function CreateGroup(t,e,i,s,a){t=CreateSVGElem("g",t);return t.setAttribute("width",s),t.setAttribute("height",a),t.setAttribute("transform",`translate(${e}, ${i})`),t}function CreateWaveFormPath(e,t,i,s){var a=(t,e)=>{return e-(t+128)*e/256},n=e.channel(0),r=CreateSVGElem("g","wav_group"+t),o=(r.setAttribute("fill-opacity","0.5"),r.setAttribute("width",e.length),"M 0 0 ");for(let t=0;t<e.length;t++){var l=n.max_sample(t);o+=`L ${t} ${a(l,100)} `}for(let t=e.length-1;0<=t;t--){var h=n.min_sample(t);o+=`L ${t} ${a(h,100)} `}var g=CreateSVGElem("path","wav_path"+t),t=(g.setAttribute("d",o),g.setAttribute("fill",COLOR_DEFINE[s].wave),CreateRect("wav_rect"+t,0,0,e.length,100,COLOR_DEFINE[s].back,COLOR_DEFINE[s].back)),s=CreateText(null,0,12,i,"12px","#000000");return r.appendChild(t),r.appendChild(g),r.appendChild(s),r}function CreateRect(t,e,i,s,a,n,r){t=CreateSVGElem("rect",t);return t.setAttribute("x",e),t.setAttribute("y",i),t.setAttribute("width",s),t.setAttribute("height",a),null!=n&&t.setAttribute("stroke",n),null!=r&&t.setAttribute("fill",r),t}function CreateLine(t,e,i,s,a,n,r){t=CreateSVGElem("line",t);return t.setAttribute("x1",e),t.setAttribute("y1",i),t.setAttribute("x2",s),t.setAttribute("y2",a),null!=n&&t.setAttribute("stroke",n),null!=r&&t.setAttribute("stroke-width",r),t}function CreateUse(t,e,i,s){t=CreateSVGElem("use",t);return t.setAttribute("href","#"+s),t.setAttribute("x",e),t.setAttribute("y",i),t}function CreateText(t,e,i,s,a,n){t=CreateSVGElem("text",t);return t.setAttribute("x",e),t.setAttribute("y",i),t.setAttribute("font-size",a),t.setAttribute("fill",n),t.textContent=s,t}function CreateCircle(t,e,i,s,a,n){t=CreateSVGElem("circle",t);return t.setAttribute("cx",e),t.setAttribute("cy",i),t.setAttribute("r",s),null!=a&&t.setAttribute("stroke",a),null!=n&&t.setAttribute("fill",n),t}function CreateLeftTriangle(t,e,i,s,a,n){t=CreateSVGElem("path",t);return t.setAttribute("d",`M${e-s/2} ${i-s/2} L${e+s/2} ${i} L${e-s/2} ${i+s/2} Z`),null!=a&&t.setAttribute("stroke",a),null!=n&&t.setAttribute("fill",n),t}function SetCursorType(t,e){t.setAttribute("cursor",e)}class Button{constructor(){this.svg=null,this.callback=null,this.fill="#CFCFCF",this.pushColor="#AF0000"}Init(t,e,i,s,a,n){e=CreateSVGElem("g",e),e.setAttribute("width",2*a),e.setAttribute("height",2*a),a=CreateCircle(null,a,a,a,"none",n);e.appendChild(a),e.addEventListener("click",this._onClick),e.addEventListener("mousedown",this._onDefaultEvent),e.addEventListener("mouseup",this._onDefaultEvent),e.addEventListener("mousemove",this._onDefaultEvent),e.addEventListener("mouseover",this._onDefaultEvent),e.setAttribute("transform",`translate(${i}, ${s})`),e.setAttribute("cursor","pointer"),t.appendChild(e),this.svg=e,this.fill=n}SetDisplay(t){this.svg.setAttribute("display",t)}SetBackColor(t){this.fill=t}SetActiveColor(t){this.pushColor=t}Move(t,e){this.svg.setAttribute("transform",`translate(${t}, ${e})`)}SetClick(t){this.callback=t}OnClickEvent(t){null!=this.callback&&this.callback(t)}_onClick=t=>(t.preventDefault(),t.stopPropagation(),this.svg.childNodes.item(0).setAttribute("fill",this.pushColor),this.OnClickEvent(t),setTimeout(()=>{this.svg.childNodes.item(0).setAttribute("fill",this.fill)},100),!1);_onDefaultEvent=t=>(t.preventDefault(),t.stopPropagation(),!1)}class PlayButton extends Button{constructor(){super()}Init(t,e,i,s,a,n){super.Init(t,e,i,s,a,n);t=CreateLeftTriangle(null,a+5,a,a,"none","blue");this.svg.appendChild(t)}}class StopButton extends Button{constructor(){super()}Init(t,e,i,s,a,n){super.Init(t,e,i,s,a,n);t=CreateRect(null,a/2,a/2,a,a,"none","red");this.svg.appendChild(t)}}class ImgButton extends Button{constructor(){super()}Init(t,e,i,s,a,n,r){super.Init(t,e,i,s,a,n);t=CreateText(null,a,a,r,"32px","#000000");t.setAttribute("text-anchor","middle"),t.setAttribute("dominant-baseline","central"),this.svg.appendChild(t)}}class SoundObject{constructor(t){this.audioBuffer=null,this.wave=null,this.svg=null,this.id=0,this.x=0,this.y=0,this.visible=!1,this.name=t,this.color_id=GetRandomInt(COLOR_DEFINE.length)}Clean(){this.audioBuffer=null,this.wave=null,this.svg=null,this.visible=!1,this.name=null,this.color_id=null}copyAudioBuffer(e){var i=new AudioBuffer({length:e.length,numberOfChannels:e.numberOfChannels,sampleRate:e.sampleRate});for(let t=0;t<i.numberOfChannels;t++){var s=e.getChannelData(t);i.copyToChannel(s,t)}return i}createWaveForm(e){return new Promise((i,s)=>{var t={audio_context:e.context,audio_buffer:this.copyAudioBuffer(this.audioBuffer),scale:2048};WaveformData.createFromAudio(t,(t,e)=>{t?s(t):(this.wave=e,i())})})}Load(t,e){return this.audioBuffer=e,this.createWaveForm(t)}SetIndex=t=>{this.id=t};CreateSVG(){this.svg=CreateWaveFormPath(this.wave,this.id,this.name,this.color_id),this.svg.setAttribute("cursor","pointer")}SetSelected(t){var e=this.svg.childNodes.item(0);t?e.setAttribute("fill",COLOR_DEFINE[this.color_id].select):e.setAttribute("fill",COLOR_DEFINE[this.color_id].back)}Size(t,e){t=GetSecParPixel(t,e),e=this.audioBuffer.duration/t,this.svg.setAttribute("width",e),t=this.wave.length;this.svg.childNodes.item(1).setAttribute("style",`transform:scale(${e/t},1);`),this.svg.childNodes.item(0).setAttribute("width",e)}SetMouseDownEvent(e){this.svg.addEventListener("mousedown",t=>(t.preventDefault(),t.stopPropagation(),e(t,this),!1))}}class PlayObject{constructor(t){this.soundObject=t,this.source=null,this.playback=!1}Init(t,e){this.source=t.createBufferSource(),this.source.buffer=this.soundObject.audioBuffer,this.source.connect(e),this.source.onended=()=>{this.playback=!1}}Play=(t,e,i,s)=>{let a=!0,n=0,r=GetSecFromWorldPos(e,i,this.soundObject.x);s<=r?(r-=s,n=0):r<s&&r+this.soundObject.audioBuffer.duration>s?(n=s-r,r=0):(a=!1,this.source=null,this.playback=!1),a&&(this.source.start(t.currentTime+r,n),this.playback=!0)};Stop(){this.playback&&this.source.stop(),this.soundObject=null,this.playback=!1,this.source=null}}class SoundObjectManager{constructor(){this.objectList=null,this.playList=null,this.drag={isMouseDown:!1,targets:null},this.bpm=120,this.widthParMeasure=120,this.indexNumber=0}GetListSize(){return null==this.objectList?0:this.objectList.length}GetObjectList(){return this.objectList}OnMouseDown=(t,e)=>{var i;0==t.button&&(i=e.svg.getBoundingClientRect(),this.drag.isMouseDown=!0,t.ctrlKey||t.metaKey?(null==this.drag.targets&&(this.drag.targets=[]),t={target:e,offsetx:i.left,offsety:i.top},e.SetSelected(!0),SetCursorType(e.svg,"grabbing"),this.drag.targets.push(t)):(null!=this.drag.targets&&0<this.drag.targets.length&&(this.drag.targets.map(t=>{t.target.SetSelected(!1),SetCursorType(t.target.svg,"pointer")}),this.ClearDragList()),this.drag.targets=[],t={target:e,offsetx:i.left,offsety:i.top},e.SetSelected(!0),SetCursorType(e.svg,"grabbing"),this.drag.targets.push(t)))};ClearDragList(){null!=this.drag.targets&&(this.drag.targets=null)}OnMouseUp(){this.drag.isMouseDown=!1,null!=this.drag.targets&&this.drag.targets.map(t=>{SetCursorType(t.target.svg,"pointer")})}AddSound(a,t,n){return new Promise((i,s)=>{a.context.decodeAudioData(t,t=>{let e=new SoundObject(n);e.Load(a,t).then(()=>{null==this.objectList&&(this.objectList=[]);var t=this.indexNumber++;e.SetIndex(t),e.CreateSVG(),e.Size(this.bpm,this.widthParMeasure),e.SetMouseDownEvent(this.OnMouseDown),this.objectList.push(e),i(t)}).catch(t=>{s(t)})},t=>{s(t)})})}play(e,i){null!=this.objectList&&this.objectList.map(async t=>{t=new PlayObject(t);t.Init(e.context,e.mainGain),t.Play(e.context,this.bpm,this.widthParMeasure,i),this.playList.push(t)})}AudioPlay(t,e){this.playList=[],this.play(t,e)}AudioSeek(t,e){null==this.playList&&(this.playList=[]);var i=this.playList.length;this.play(t,e);for(let t=0;t<i;t++)this.playList[t].Stop();0<i&&this.playList.splice(0,i)}AudioStop(){null!=this.playList&&(this.playList.map(t=>{t.Stop()}),this.playList=null)}DeleteAudio(t){var e;null!=this.objectList&&(-1!=(e=this.GetPlayListIndex(t))&&(this.playList[e].Stop(),this.playList.splice(e,1)),-1!=(e=this.GetSoundListIndex(t)))&&null!=(t=this.objectList.splice(e,1))&&t[0].Clean()}SetBpmMeaure(t,e){this.bpm=t,this.widthParMeasure=e}GetSoundListIndex(e){if(null!=this.objectList)for(let t=0;t<this.objectList.length;t++)if(this.objectList[t].id==e)return t;return-1}GetPlayListIndex(e){if(null!=this.playList)for(let t=0;t<this.playList.length;t++)if(this.playList[t].soundObject.id==e)return t;return-1}}class TextBox{constructor(t){this.id=t,this.onChange=null}Init(){GetElem(this.id).addEventListener("change",this.OnChange)}OnChange=()=>{null!=this.onChange&&this.onChange(GetElem(this.id).value)};SetOnChangeEvent(t){this.onChange=t}}class SelectBox{constructor(t){this.id=t,this.onChange=null}Init(){GetElem(this.id).addEventListener("change",this.OnChange)}OnChange=()=>{null!=this.onChange&&this.onChange(GetElem(this.id).value)};SetOnChangeEvent(t){this.onChange=t}}class View{constructor(t){this.mainFrame=t,this.bkColor=VIEW_BACK_COLOR,this.lineColor=VIEW_MEASURE_LINE_COLOR,this.lineColor2=VIEW_BEAT_LINE_COLOR,this.progressColor=VIEW_PROGRESS_COLOR,this.measureSize=DEFAULT_MEASURE_WIDTH,this.bpm=DEFAULT_BPM,this.camera={x:0,y:0},this.soundManager=null,this.optLine=DEFAULT_DIVIDE_NUM,this.progress={isMouseDown:!1,worldPosition:0},this.leftMoveBtn=null,this.rightMoveBtn=null,this.playBtn=null,this.stopBtn=null,this.seekCallback=null}Init(){this.InitCamera(),this.createView()}InitCamera(){this.camera.x=0,this.camera.y=0}SetBpmMeasure(e,i){let s=!1,a=this.measureSize;this.measureSize!=i&&(s=!0),this.bpm=e,this.measureSize=i;var t=GetElem("view_group");null!=t&&(this.ReSize(t.getAttribute("width"),t.getAttribute("height")),null!=(t=this.soundManager.GetObjectList()))&&t.map(async t=>{t.Size(e,i),s&&this.calcStartPosForSoundObject(t,a)})}calcStartPosForSoundObject(t,e){e=GetMeasurePos(e,t.x),e=GetWorldPosFromMeasurePos(this.bpm,this.measureSize,e);t.x=e,t.svg.setAttribute("transform",`translate(${t.x-this.camera.x}, ${t.y-this.camera.y})`)}SetDivide(t){this.optLine=t;t=GetElem("view_group");null!=t&&this.ReSize(t.getAttribute("width"),t.getAttribute("height"))}SetCamera(t,e){this.camera.x=t,this.camera.y=e,this.MoveSoundObject(),this.updateMeasureNumber(),this.flashProgress()}TrackCameraToProgress(){var t=this.progress.worldPosition,e=this.camera.x,i=this.GetViewWidth();(t<e||e+i<t)&&(e=parseInt(t/this.measureSize)*this.measureSize,this.SetCamera(e,0))}SetSoundManager(t){this.soundManager=t}GetSnapPosition(t){var e=this.measureSize/this.optLine;return parseInt(t/e)*e}MoveSoundObject(){var t=this.soundManager.GetObjectList();null!=t&&t.map(async t=>{t.svg.setAttribute("transform",`translate(${t.x-this.camera.x}, ${t.y-this.camera.y})`)})}SetVisibleSoundObject(t){t=this.soundManager.GetSoundListIndex(t),t=this.soundManager.GetObjectList()[t];GetElem(this.mainFrame).appendChild(t.svg),t.visible=!0}SetSoundObjectPositionLocal(t,e,i){t=this.soundManager.GetSoundListIndex(t),t=this.soundManager.GetObjectList()[t],e=this.GetSnapPosition(e),e=this.LocalToWorldX(e),i=(i=this.LocalToWorldY(i))<0?0:i;t.x=e<0?0:e,t.y=i,t.svg.setAttribute("transform",`translate(${t.x-this.camera.x}, ${t.y-this.camera.y})`)}ReSize(t,e){var i=GetElem("view_group"),s=(i.setAttribute("width",t),i.setAttribute("height",e),GetElem("view_rect"));s.setAttribute("width",t),s.setAttribute("height",e),Array.from(i.childNodes).forEach(t=>{"view_rect"!=t.id&&t.remove()}),this.createViewLine(i,t,e),this.createMeasureNumber(i,t),this.resizeProgress(e),this.resizeButton(t,e)}GetViewWidth(){return GetElem(this.mainFrame).getAttribute("width")}GetViewHeight(){return GetElem(this.mainFrame).getAttribute("height")}createView(){var t=GetElem(this.mainFrame),e=t.getAttribute("width"),i=t.getAttribute("height"),s=CreateSVGElem("g","view_group"),a=(s.setAttribute("width",e),s.setAttribute("height",i),CreateRect("view_rect",0,0,e,i,this.bkColor,this.bkColor));s.appendChild(a),this.createViewLine(s,e,i),this.createMeasureNumber(s,e),t.appendChild(s),this.createProgress(),this.createButton(t,e,i),t.addEventListener("mousedown",this.OnMouseDown)}createButton(t,e,i){var s=BUTTON_RADIUS;this.leftMoveBtn=new ImgButton,this.rightMoveBtn=new ImgButton,this.playBtn=new PlayButton,this.stopBtn=new StopButton,this.leftMoveBtn.Init(t,"btnLeftMove",0,i-2*s,s,"#CFCFCF","<<"),this.rightMoveBtn.Init(t,"btnRightMove",e-2*s,i-2*s,s,"#CFCFCF",">>"),this.playBtn.Init(t,"btnPlayback",e/2,i-2*s,s,"#CFCFCF"),this.stopBtn.Init(t,"btnStop",e/2,i-2*s,s,"#CFCFCF"),this.stopBtn.SetDisplay("none");const a=()=>{var t=new Event("click");GetElem("startBtn").dispatchEvent(t)};this.leftMoveBtn.SetClick(t=>{let e=this.camera.x-this.measureSize;e<0&&(e=0),this.SetCamera(e,this.camera.y)}),this.rightMoveBtn.SetClick(t=>{var e=this.camera.x+this.measureSize;this.SetCamera(e,this.camera.y)}),this.playBtn.SetClick(t=>{this.playBtn.SetDisplay("none"),this.stopBtn.SetDisplay("inline"),a()}),this.stopBtn.SetClick(t=>{this.stopBtn.SetDisplay("none"),this.playBtn.SetDisplay("inline"),a()})}resizeButton(t,e){var i=BUTTON_RADIUS;this.leftMoveBtn.Move(0,e-2*i),this.rightMoveBtn.Move(t-2*i,e-2*i),this.playBtn.Move(t/2,e-2*i),this.stopBtn.Move(t/2,e-2*i)}createViewLine(e,i,s){var a=CreateGroup("line_box",0,0,this.measureSize,s);for(let t=1;t<this.optLine;t++)a.appendChild(CreateLine(null,t*(this.measureSize/this.optLine),0,t*(this.measureSize/this.optLine),s,this.lineColor2,1));a.appendChild(CreateLine(null,this.measureSize,0,this.measureSize,s,this.lineColor,1)),e.appendChild(a);for(let t=1;t<i/this.measureSize;t++)e.appendChild(CreateUse(null,t*this.measureSize,0,"line_box"))}createMeasureNumber(t,e){var i=CreateGroup("number_box",0,0,e,60),s=parseInt(this.camera.x/this.measureSize);for(let t=0;t<e/this.measureSize;t++){var a=CreateText(null,t*this.measureSize,15,""+(s+t+1),"11px","#000000");i.appendChild(a)}t.appendChild(i)}updateMeasureNumber(){var t=GetElem("number_box");let i=parseInt(this.camera.x/this.measureSize);Array.from(t.childNodes).forEach((t,e)=>{t.textContent=""+(i+e+1)})}createProgress(){var t=GetElem(this.mainFrame),e=CreateLine("progress",0,0,0,t.getAttribute("height"),this.progressColor,1.5);t.appendChild(e)}resizeProgress(t){GetElem("progress").setAttribute("y2",t)}moveProgress(t){var e=GetElem("progress"),t=(this.progress.worldPosition=t,this.WorldToLocalX(t));e.setAttribute("x1",t),e.setAttribute("x2",t);e=GetElem(this.mainFrame).getAttribute("width"),e=parseInt(e/this.measureSize)*this.measureSize;e<=t&&this.SetCamera(this.camera.x+e,0)}flashProgress(){var t=GetElem("progress"),e=this.WorldToLocalX(this.progress.worldPosition);t.setAttribute("x1",e),t.setAttribute("x2",e)}getWorldProgress(){return this.progress.worldPosition}OnMouseDown=t=>(t.preventDefault(),t.stopPropagation(),this.progress.isMouseDown=!0,this.progress.worldPosition=this.GetSnapPosition(this.camera.x+t.clientX),this.seekCallback&&this.seekCallback(),!1);OnMouseMove(e){var t=this.soundManager.drag;t.isMouseDown&&t.targets.map(async t=>{t.offsetx=t.offsetx+e.movementX,t.offsety=t.offsety+e.movementY,this.SetSoundObjectPositionLocal(t.target.id,t.offsetx,t.offsety)})}OnMouseUp(t){this.soundManager.drag.isMouseDown&&this.seekCallback&&this.seekCallback(),this.soundManager.OnMouseUp(),this.progress.isMouseDown&&(this.progress.isMouseDown=!1,this.moveProgress(this.progress.worldPosition))}DeleteSelectedAudio(){let e=GetElem(this.mainFrame);this.soundManager.drag.targets.map(t=>{e.removeChild(t.target.svg),this.soundManager.DeleteAudio(t.target.id)}),this.soundManager.ClearDragList()}LocalToWorldX(t){return this.camera.x+t}WorldToLocalX(t){return t-this.camera.x}LocalToWorldY(t){return this.camera.y+t}WorldToLocalY(t){return t-this.camera.y}SetSeekCallback(t){this.seekCallback=t}}class Player{constructor(t){this.view=t,this.soundObjectManager=new SoundObjectManager,this.bpm=DEFAULT_BPM,this.widthParMeasure=DEFAULT_MEASURE_WIDTH,this.volume=DEFAULT_VOL,this.playbackState="stop",this.progressPos=0,this.startTime=0,this.interval=null,this.webAudio={context:null,mainGain:null},this.bpmBox=new TextBox("bpm"),this.measureBox=new TextBox("measure"),this.divideBox=new SelectBox("divide")}Init(){this.view.SetBpmMeasure(this.bpm,this.widthParMeasure),this.view.SetSoundManager(this.soundObjectManager),this.view.SetSeekCallback(this.seekCallback),this.soundObjectManager.SetBpmMeaure(this.bpm,this.widthParMeasure),this.bpmBox.Init(),this.bpmBox.SetOnChangeEvent(this.ChangeBpm),this.measureBox.Init(),this.measureBox.SetOnChangeEvent(this.ChangeMeasure),this.divideBox.Init(),this.divideBox.SetOnChangeEvent(this.ChangeDivide)}initAudio(){null==this.webAudio.context&&(this.webAudio.context=new(window.AudioContext||window.webkitAudioContext),this.webAudio.mainGain=this.webAudio.context.createGain(),this.webAudio.mainGain.gain.value=this.volume,this.webAudio.mainGain.connect(this.webAudio.context.destination))}ChangeMasterVol=t=>{this.volume=t,this.webAudio.mainGain.gain.value=this.volume};ChangeBpm=t=>{this.bpm=t,this.view.SetBpmMeasure(this.bpm,this.widthParMeasure)};ChangeMeasure=t=>{this.widthParMeasure=t,this.view.SetBpmMeasure(this.bpm,this.widthParMeasure)};ChangeDivide=t=>{this.view.SetDivide(t)};AddSound(t,i){return new Promise((s,e)=>{this.initAudio(),this.soundObjectManager.AddSound(this.webAudio,t,i).then(t=>{var e=GetRandomInt(100),i=GetRandomInt(100);this.view.SetSoundObjectPositionLocal(t,e,i),this.view.SetVisibleSoundObject(t),s(this.soundObjectManager.GetListSize())}).catch(t=>{e(t)})})}updateProgress=()=>{var t,e,i;"play"==this.playbackState&&(e=(t=this.webAudio.context.currentTime)-this.startTime,i=GetSecParPixel(this.bpm,this.widthParMeasure),this.startTime=t,this.progressPos+=e/i,this.view.moveProgress(this.progressPos))};Start=()=>{var t;"stop"==this.playbackState&&(this.initAudio(),this.playbackState="play",this.progressPos=this.view.getWorldProgress(),this.view.moveProgress(this.progressPos),this.view.TrackCameraToProgress(),t=GetSecFromWorldPos(this.bpm,this.widthParMeasure,this.progressPos),this.soundObjectManager.SetBpmMeaure(this.bpm,this.widthParMeasure),this.soundObjectManager.AudioPlay(this.webAudio,t),this.startTime=this.webAudio.context.currentTime,this.interval=setInterval(this.updateProgress,100))};Stop=()=>{this.playbackState="stop",this.soundObjectManager.AudioStop(),clearInterval(this.interval),this.interval=null};Seek=()=>{var t;"seek"==this.playbackState&&(this.progressPos=this.view.getWorldProgress(),t=GetSecFromWorldPos(this.bpm,this.widthParMeasure,this.progressPos),this.soundObjectManager.AudioSeek(this.webAudio,t),this.startTime=this.webAudio.context.currentTime,this.playbackState="play")};Mixing=i=>{let s=new Mixing;try{s.Init(this.soundObjectManager.GetObjectList(),this.bpm,this.widthParMeasure,this.volume),s.Mixing((t,e)=>{if(e)throw e;s.Download(t),s.Close(),i()})}catch(t){window.alert(t),s.Close(),i()}};seekCallback=()=>{"play"==this.playbackState&&(this.playbackState="seek"),this.Seek()};OnMouseUp(t){this.view.OnMouseUp(t)}OnMouseMove(t){this.view.OnMouseMove(t)}OnKeyDown(t){var e;"Backspace"==t.code&&this.view.DeleteSelectedAudio(),"SPACE"==t.code&&(e=new Event("click"),GetElem("startBtn").dispatchEvent(e)),"Home"==t.code&&this.view.SetCamera(0,0)}setBpm(t){this.bpm=t}getBpm(){this.bpm}setWidthParMeasure(t){this.widthParMeasure=t}getWidthParMeasure(){return this.widthParMeasure}}class Mixing{constructor(){this.context=null,this.gain=null,this.objectList=null,this.sampleRate=44100,this.channelNum=2,this.length=0,this.bpm=0,this.widthParMeasure=0}Init(t,e,i,s){if(null==t||0==t.length)throw new Error("audio object list is empty");this.objectList=t,this.bpm=e,this.widthParMeasure=i,this.length=this.getMixDuration(t),this.context=new OfflineAudioContext(this.channelNum,this.length*this.sampleRate,this.sampleRate),this.gain=this.context.createGain(),this.gain.value=s,this.gain.connect(this.context.destination)}Close(){this.gain=null,this.context=null,this.objectList=null}Mixing(e){this.objectList.map(async t=>{var e=GetSecFromWorldPos(this.bpm,this.widthParMeasure,t.x),i=this.context.createBufferSource();i.buffer=t.audioBuffer,i.connect(this.gain),i.start(this.context.currentTime+e)}),this.context.startRendering().then(t=>{t=window.audioBufferToWav(t);e(t,null)}).catch(t=>{e(null,t)})}Download(t){var t=new Blob([t],{type:"audio/wav"}),t=URL.createObjectURL(t),e=(new Date,document.createElement("a"));e.href=t,e.download=this.createFilename(),e.click()}createFilename(){var t=new Date;return"mix_"+t.getFullYear()+("00"+(t.getMonth()+1)).slice(-2)+("00"+t.getDate()).slice(-2)+("00"+t.getHours()).slice(-2)+("00"+t.getMinutes()).slice(-2)+("00"+t.getSeconds()).slice(-2)}getMixDuration(e){var i=0;for(let t=0;t<e.length;t++){var s=this.getSoundEndTime(e[t]);i<s&&(i=s)}return i}getSoundEndTime(t){return GetSecFromWorldPos(this.bpm,this.widthParMeasure,t.x)+t.audioBuffer.duration}}var player=null,view=null;function init(){view=new View("mainframe"),(player=new Player(view)).Init(),initView("mainframe"),initWindowEvent(),initAudioAddAction(onAddEvent),initStartAudioAction(),initMixAudioAction(),initMasterVolume()}function loadAudioFile(t,e){if(-1==t.type.indexOf("audio"))window.alert(t.name+" is no audio file");else{const i=new FileReader;i.onload=()=>{e&&e(i.result,t.name)},i.readAsArrayBuffer(t)}}function initAudioAddAction(t){var e=GetElem("audioFile");e.onchange=function(){loadAudioFile(e.files[0],t)}}function initStartAudioAction(){var t=GetElem("startBtn");t.addEventListener("click",()=>{"PLAY"==t.innerText?(t.innerText="STOP",player.Start()):(t.innerText="PLAY",player.Stop())})}function initMixAudioAction(){var t=GetElem("mixBtn");t.addEventListener("click",()=>{"MIX"==t.innerText?(t.innerText="MIXING",player.Mixing(()=>{t.innerText="MIX"})):window.alert("Mixing is running. please wait.")})}function initMasterVolume(){var t=GetElem("mastervol");t.addEventListener("input",()=>{player.ChangeMasterVol(t.value)})}function initView(t){var e=window.innerWidth-ADJUST_WIDTH,i=window.innerHeight-ADJUST_HEIGHT,t=GetElem(t);t.setAttribute("width",e),t.setAttribute("height",i),t.addEventListener("dragover",t=>(t.stopPropagation(),t.preventDefault(),!1)),t.addEventListener("dragleave",t=>(t.stopPropagation(),t.preventDefault(),!1)),t.addEventListener("drop",t=>{t.stopPropagation(),t.preventDefault();new FileReader;return loadAudioFile(t.dataTransfer.files[0],onAddEvent),!1}),view.Init()}function ReSize(t){var e=window.innerWidth-ADJUST_WIDTH,i=window.innerHeight-ADJUST_HEIGHT,t=GetElem(t);t.setAttribute("width",e),t.setAttribute("height",i),view.ReSize(e,i)}function initWindowEvent(){window.addEventListener("resize",()=>{ReSize("mainframe")}),document.addEventListener("mouseup",t=>{player.OnMouseUp(t)}),document.addEventListener("mousemove",t=>{player.OnMouseMove(t)}),document.addEventListener("keydown",t=>(player.OnKeyDown(t),!1))}function onAddEvent(t,e){player.AddSound(t,e).then(t=>{}).catch(t=>{window.alert(t)})}init();